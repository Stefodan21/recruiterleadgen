name: leadgen-deploy


on:
    workflow_dispatch:
    pull_request:
        branches: ['prod']

concurrency:
    group: leadgen-deploy
    cancel-in-progress: true

jobs:
    search:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4

            - name: Build search image
              run: docker build -t search ./search

            - name: Run search
              run: docker run --rm -v ${{ github.workspace }}:/app search

            - uses: actions/upload-artifact@v4
              with:
                name: profile-links
                path: profile-links.json

    
    ingestion:
        needs: search
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4

            - uses: actions/download-artifact@v4
              with:
                name: profile-links

            - name: Build ingestion image
              run: docker build -t ingestion ./ingestion
  
            - name: Build ingestion image
              run: docker run --rm -v ${{ github.workspace }}:/app ingestion

            - uses: actions/upload-artifact@v4
              with:
                name: ingested-data
                path: ingested-data.json

    field_extraction:
        needs: ingestion
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4

            - uses: actions/download-artifact@v4
              with:
                name: ingested-data

            - name: Build field extraction image
              run: docker build -t field-extraction ./field_extraction

            - name: Run field extraction
              run: docker run --rm -v ${{ github.workspace }}:/app field-extraction

            - uses: actions/upload-artifact@v4
              with:
                name: extracted-fields
                path: extracted-fields.json

    export:
        needs: field_extraction
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4

            - uses: actions/download-artifact@v4
              with:
                name: extracted-fields

            - name: Build export image
              run: docker build -t export ./export

            - name: Run export
              run: docker run --rm \
                -v ${{ github.workspace }}:/app \
                -e AIRTABLE_API_KEY=${{ secrets.AIRTABLE_API_KEY }} \
                export 



